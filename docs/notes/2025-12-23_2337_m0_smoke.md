# M0-1 Smoke Test 留痕

## 做了什么

1. 创建目录结构：`scripts/lib/`、`runs/`、`docs/notes/`
2. 创建 `.gitignore`（忽略 `runs/`、`data/`、`node_modules/`）
3. 创建 `package.json`（含 `m0:smoke` 脚本）
4. 创建 `scripts/lib/run_codex_exec.js`：
   - 封装 `codex exec` 调用
   - 自动检测 `.git`（向上查找父目录直到根目录），无则追加 `--skip-git-repo-check`
   - stdout → `events.jsonl`
   - stderr → `stderr.log`
   - 读取 `--output-last-message` 产出的 `last_message.txt`
   - 平台检测：仅 Windows 使用 `shell: true`（Linux/macOS 不使用以保持安全）
5. 创建 `scripts/codex_smoke.js`：
   - 调用封装，发送约束 prompt（只能回复 "OK"）
   - 校验 `lastMessage.trim() === "OK"`

## 修复记录

- **Issue 1**: 留痕文档年份错误 2024 → 2025（已修复）
- **Issue 2**: `shell: true` 在 Web 场景下有风险 → 改为平台检测，仅 Windows 使用
- **Issue 3**: git 检测只看 `cwd/.git` 会误判子目录 → 改为向上查找父目录

## 环境信息

- **node**: v22.16.0
- **codex-cli**: 0.77.0
- **OS**: Windows 11
- **cwd**: `E:\sjt\others\auto_codex`

## 验证命令

```bash
npm run m0:smoke
```

## 结果（修复后重跑）

- **Exit code**: 0
- **生成目录**: `runs/smoke-20251223_234421/`
- **产物**:
  - `events.jsonl` ✓
  - `last_message.txt` — 内容: `OK` ✓
  - `stderr.log` ✓
- **校验**: `lastMessage.trim() === "OK"` ✓ PASS

## 下一步

M0-2：为 Manager/Executor 分别创建 system prompt，并验证 Manager 能输出 `Done` 结束循环。
