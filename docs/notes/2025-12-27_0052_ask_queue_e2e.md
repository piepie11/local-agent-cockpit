# Ask 队列 e2e 测试补齐

目标：确保 Ask 队列在无浏览器的 API e2e 下可复现、可回归：
- busy 时 `/send` 仍可 enqueue 多条
- 队列项支持编辑（queued）与删除（queued/error）
- 最终聊天消息中体现“编辑后的文本”，且“被删除的项”不会落入消息记录

## 覆盖点

- `scripts/m4_ask_e2e.js`
  - `/send` 响应校验增加 `queueItem.id`
  - 新增用例：创建 `delayMs` 较大的 fake thread
    - 先发送一条占用 running
    - 再快速 enqueue 两条 → PATCH 第二条文本 → DELETE 第三条
    - 等待 thread idle 后验证：
      - user messages 中出现 `second edited`
      - 不出现 `second original` / `third to delete`
      - queue 中无 pending（queued/running）

## 修复

- 修复 `prepareAskSend()` 中误删 `workspace` 变量导致的 `ReferenceError: workspace is not defined`，
  该错误会让队列项直接进入 `error` 状态且不会生成任何 ask_messages。

