# Files：e2e 测试（workspace fs API）

目标：为 Files 功能补一个“不依赖浏览器”的 e2e，用来覆盖关键权限/安全/并发冲突场景，避免后续重构引入回归。

## 覆盖点

- list：无 token 不返回 dotfiles/dotdir；有 `ADMIN_TOKEN` 才能看到隐藏项
- read：无 token 读取隐藏路径返回 `403 HIDDEN_PATH_FORBIDDEN`
- write：写入必须带 token（后端 `PUT /fs/text` 也会强制 `requireAdmin`）
- optimistic lock：基于 `baseMtimeMs`，mtime 不一致返回 `409 FILE_CHANGED`
- blob：图片走 `GET /fs/blob`，并验证 `Content-Type`（例如 `image/png`）
- 安全：写入二进制文件（例如 png）返回 `400 FILE_NOT_TEXT`

## 运行方式

- `npm run m5:files:e2e`
- 或 `node scripts/m5_files_e2e.js`

说明：脚本会在 `runs/files-e2e-*` 下生成临时 workspace 与 sqlite/db artifacts（已在 `.gitignore` 中忽略）。

