# Ask 队列（DB + Store）落地

目标：为“随口问（Ask）支持排队/编辑/删除”打基础，先把队列做成可持久化的数据结构，避免纯内存实现导致的丢失/不可编辑等问题。

## 设计要点

- 队列项与 `ask_messages` 解耦：排队时只创建 `ask_queue_items`；真正生成用户消息在“队列执行时”发生，保证编辑会生效。
- 持久化队列：后端重启后队列仍在（后续由 worker 继续处理）。
- 原子 claim：通过 `BEGIN IMMEDIATE` + `UPDATE ... WHERE status='queued'` 的方式领取下一条，避免并发重复执行。

## 变更

- 新增表：`ask_queue_items`
  - 字段：`id, threadId, status(queued/running/error), text, error, metaJson, createdAt, updatedAt, startedAt, endedAt`
  - 索引：`(threadId, status, createdAt)`、`(threadId, createdAt)`，以及 `status='running'` 的 per-thread 唯一约束
- `Store` 新增方法：
  - `listAskQueueItems(threadId, limit)`
  - `getAskQueueItem(id)`
  - `createAskQueueItem(...)`
  - `updateAskQueueItem(id, patch)`
  - `deleteAskQueueItem(id)`
  - `claimNextAskQueueItem(threadId)`（事务+原子更新）

## 后续

下一步接入：
- Ask Service：enqueue + 后台 drain worker（串行执行队列）
- API：queue 列表/编辑/删除接口
- Web：队列面板与移动端交互适配

