# Web 编排器：Manager 与 Executor（支持 Codex / Claude Code）工程计划（plan.md）

> 目标：做一个手机也能舒服用的 Web 控制台，用来驱动“总管（Manager）与执行者（Executor）”交替执行 plan.md。
> 特别强调：**总管负责诊断与下指令；执行者负责改代码/跑命令；两者对话与日志在 Web 上可回看、可导出、可新开会话**。
> 同时支持两种 CLI 后端：OpenAI Codex CLI、Anthropic Claude Code CLI。

---

## 0. 背景与关键约束（务必先读）

### 0.1 为什么选"CLI + Web 控制台"而不是"脚本操纵两个终端窗口"
- 你要的核心是"可编排的回合制对话 + 可回放日志 + 可移动端操作"。用 CLI 的**非交互模式**（Codex 的 `codex exec`、Claude 的 `claude -p`）更可控、更适合 Web 端流式展示与持久化。
- Codex：优先使用 `codex exec`（支持 `--json` JSONL 事件流、`--output-schema`、`--output-last-message`、`--sandbox` 等）；`codex exec resume` 可续会话但目前不提供 JSONL 事件流，因此 MVP 先走“显式上下文 + 单轮 exec”。
- Claude Code 支持 `--output-format json/stream-json`（可脚本解析）、`--include-partial-messages`（流式 partial）、`--resume/--session-id/--fork-session`（会话管理）、`--json-schema`（结构化输出验证）。

### 0.2 平台支持
- **Windows 原生支持**：本项目已验证在 Windows 上原生运行（使用 `codex.cmd`），无需 WSL。
- macOS/Linux 同样支持。
- 本项目目标是"手机访问"，因此服务端建议跑在**你随身笔记本/小主机/云端**，手机只做浏览器访问。

---

## 1. 产品目标（MVP）与非目标

### 1.1 MVP 必须做到（DoD）
1) **项目/工作区（Workspace）管理**
   - **Workspace Registry**：可添加多个 workspace（id/name/absPath/planPath），UI 下拉选择。
   - 路径必须在允许列表（安全白名单）内。
   - 显示 repo 概况（可配置开关）：文件树摘要、git status、diff stat。

2) **会话（Session）管理**
   - 支持新开/重置：
     - 新开一个 Manager 会话（可选 Codex 或 Claude）
     - 新开一个 Executor 会话（可选 Codex 或 Claude）
   - 支持"绑定到 Run"：一个 Run = (workspace + plan + managerSession + executorSession + 配置)。

3) **Run（执行回合）**
   - **并行 Runs**：允许多个 run 同时 RUNNING；但同一 workspace 默认加锁（同一时间只能 1 个 RUNNING，避免互相改代码）。
   - **全局并发限制**：`MAX_CONCURRENT_RUNS`（防止 API/本机资源被打爆）。
   - **落盘隔离**：`runs/<workspaceId>/<runId>/...`，避免多项目混淆。
   - 点击 Start 后自动循环：
     1) 把（plan + repoDigest + executor 上轮日志 + manager 固定提示词）发给 Manager
     2) Manager 输出：下一步指令（或 `Done`）
     3) 若 `Done` => Run 结束
     4) 否则把（manager 指令 + executor 固定提示词）发给 Executor
     5) Executor 执行并回传日志
   - 提供 Stop/Pause/Step（三个控制）：
     - Stop：立即 kill 当前 CLI 子进程并结束 Run
     - Pause：在本轮结束后暂停（不进入下一轮）
     - Step：只执行一轮（Manager→Executor）或半轮（仅 Manager / 仅 Executor，见配置）

4) **Web 端"聊天记录/日志回看"**
   - 每条消息（prompt 与 output）都入库，按 Run 可回放
   - 支持导出：Markdown / JSON / 原始事件流（jsonl）
   - 支持"快速定位"：按轮次、按关键词筛选

5) **移动端体验**
   - 响应式布局：手机上默认"上下两段"（Manager/Executor 可切 tab）
   - 大按钮操作（Start/Stop/Pause/Step）
   - 弱网友好：断线自动重连，继续拉取最新事件

6) **Runs 列表页**
   - 显示所有 runs 状态（RUNNING/PAUSED/DONE/ERROR）、最近事件、Stop/Pause 快捷按钮。
   - 点进去才看单个 Run Dashboard。

### 1.2 非目标（明确不做，避免 scope 爆炸）
- 不做多 Agent（评价官/终止官）复杂编排（后续可加）
- 不做多人协作/权限体系（只做单用户或单 token）
- 不做把 Codex/Claude 的交互 TUI 镜像到网页（只做非交互 exec/print 模式）

---

## 2. 总体架构

### 2.1 组件
- Web Server（Node.js / JavaScript（CommonJS））
  - REST API：Run/Session/Workspace 管理
  - Streaming：SSE（推荐）或 WebSocket（可选）
- Orchestrator（状态机）
  - 回合循环、暂停/停止、超时、空跑保护
- Provider Adapters（关键：多后端）
  - CodexAdapter：调用 `codex exec`（首选，支持 `--json`/`--output-schema`/`--output-last-message`/`--sandbox` 等）；`codex exec resume` 可选（续会话，但无 JSONL 事件流）
  - ClaudeAdapter：调用 `claude -p`（支持 `--output-format stream-json`、`--include-partial-messages`、`--resume`、`--json-schema` 等）
- Storage（SQLite）
  - workspaces / runs / sessions / turns / events / artifacts（导出文件索引）
- Web UI（移动优先）
  - Run Dashboard（实时）
  - History（回放/搜索/导出）
  - Sessions（新开/切换/重置）
  - Settings（模型/权限/阈值/密钥检查）

---

## 3. Provider 统一抽象（为"同时支持 Codex + Claude"打地基）

### 3.1 统一接口（伪码）
- Provider = "codex" | "claude"
- Session = { id, provider, role, workspaceId, createdAt, meta }
- TurnRequest = { sessionId, role, prompt, cwd, schema?, streamMode, limits }
- TurnResult = { finalText, structured?, events[], usage? }

统一方法：
- `startSession(role, provider, options) -> session`
- `runTurn(request, onEvent) -> result`
- `resumeSession(sessionId, options) -> session`（对外可选；内部让 runTurn 自动处理）
- `stop(processHandle)`（可中断）

### 3.2 CodexAdapter（实现要点）
- 使用 `codex exec` 作为非交互入口（支持输出 JSONL 事件流）。
- 推荐默认参数：
  - `--cd <workspaceRoot>`：锁定工作区
  - `--json`：拿 JSONL 事件流（流式推 UI）
  - Executor：`--full-auto`（低摩擦自动化 preset）或 `--sandbox workspace-write`（更显式）
  - Manager：`--sandbox read-only`（只读诊断）
- 结构化输出：
  - `--output-schema <path>`：Codex 侧校验最终输出形状（强烈建议用于 Manager 的"指令包"）
- 会话续跑（可选，受限）：
  - `codex exec resume [SESSION_ID]` 或 `--last`（按 run 记录 sessionId 优先）
  - 注意：`resume` 当前不支持 `--json`/`--output-last-message`；若需要完整事件流与稳定落盘，优先继续用 `codex exec` + 显式上下文。
- 日志落盘：
  - `codex exec --output-last-message <file>` 可直接写入最终消息便于归档（推荐配合 `--json` 同时保存事件流）。

### 3.3 ClaudeAdapter（实现要点）
- 非交互模式：`claude -p`（print mode）
- 流式事件：
  - `--output-format stream-json` + `--include-partial-messages`（SSE 推送更丝滑）
- 会话管理：
  - `--resume <id|name>`：续会话
  - `--session-id <uuid>`：显式指定 session id（便于"新开会话"在 DB 先占位）
  - `--fork-session`：在 resume 基础上分叉新会话（等价"复制上下文另起一支线"）
- 结构化输出验证：
  - `--json-schema '<schema>'`：让 Claude 输出满足 schema 的 JSON（适合 Manager 指令结构化）。
- Turn 限制：
  - `--max-turns N`：防止 agentic 无限转圈（建议 Executor 默认 8~12，可配置）。
- 调试日志：
  - 文档提到可写入 `~/.claude/debug/`（可选：UI 提供"打开调试日志位置"提示）。

---

## 4. 核心编排协议：让"总管只输出 Done"且自动化稳定

### 4.1 Manager 输出协议（推荐：半结构化 + Done）
- **完成时**：输出严格等于 `Done`（无前后空格、无标点、无代码块）
- **未完成时**：输出一个"指令包"，建议格式：

```
<MANAGER_PACKET>
GOAL: 本轮目标（1-2 句）
DIAGNOSIS: 对 executor 日志 + plan.md 的诊断要点（最多 8 条）
INSTRUCTIONS:
1) ...
2) ...
ACCEPTANCE:
- 本轮完成的验收点（清单）
SCOPE_GUARD:
- 不要做哪些事（防发散）
</MANAGER_PACKET>
```

> 工程实现：Orchestrator 先 `trim()` 判断是否完全等于 `Done`，否则按文本原样交给 Executor（无需解析也能跑）。
> 进阶：可切"严格模式"，要求 Manager 输出 JSON 并用 schema 校验（Codex `--output-schema` / Claude `--json-schema`）。

### 4.2 Executor 输出协议（建议结构化，便于总管诊断）
Executor 每轮必须输出：

```
<EXEC_LOG>
SUMMARY: 做了什么（1-5 行）
CHANGES:
- path/to/file1
- path/to/file2
COMMANDS:
- npm test
- ...
RESULTS:
- tests: pass/fail（含关键报错摘要）
- build: pass/fail
RISKS:
- 潜在风险/不确定点
QUESTIONS:
- 需要总管决策的问题（若无填 None）
</EXEC_LOG>
```

---

## 5. Web 功能详细清单（移动端优先）

### 5.1 页面：Run Dashboard（核心）
- 顶栏（手机友好）：
  - Workspace 下拉选择
  - Provider 选择：Manager/Executor 各自独立（codex/claude）
  - Model（可选：provider 内部选项；先做"字符串透传"）
  - 控制按钮：Start / Pause / Step / Stop（大按钮）
  - 状态：Running/Paused/Stopped、turnIndex、当前进程 PID/状态
- 主体（手机默认 Tab）：
  - Tab1：Manager Feed（流式、可折叠每轮）
  - Tab2：Executor Feed
  - Tab3：Plan 预览（plan.md 原文 + 高亮本轮相关段落）
  - Tab4：Repo Digest（可选开关：tree、git status、diff stat）
- 辅助操作：
  - "新开 Manager 会话 / 新开 Executor 会话"（不影响历史 Run，可新建绑定）
  - "在本轮插一句话"（手动注入：给 Manager 或 Executor 添加一条额外指令，再继续）
  - "导出本 Run"（md/json/jsonl 一键下载）

### 5.2 页面：History（聊天记录/日志回看）
- 左侧列表：Runs（按 workspace 分组，按时间倒序）
- 右侧详情：
  - 按轮次展开：Manager prompt / Manager output / Executor prompt / Executor output
  - 搜索：关键词、文件名、命令、失败轮次
  - 导出：Markdown（可直接发人/存档）、JSON（便于二次分析）

### 5.3 页面：Sessions（会话管理）
- 列表：所有 session（role/provider/workspace/创建时间/最后活跃）
- 操作：
  - 新建 session（可选 provider、role）
  - 绑定到现有 run（把 run 的 managerSession 或 executorSession 切换为此 session）
  - Claude：支持"fork session"按钮（调用 `--fork-session` 跑一次空 turn 或在下一次 resume 时生效）
  - 重置 session（本质新建并替换绑定；旧的保留可回看）

### 5.4 页面：Settings（安全与体验）
- 安全（强烈建议 MVP 就做）：
  - 访问口令（一个简单的 ADMIN_TOKEN，写入环境变量）
  - "危险命令保护"开关：禁止 executor 运行 `rm -rf`/`del /s` 等（先用正则黑名单）
- 运行参数：
  - MAX_TURNS（默认 50）
  - 每轮超时（例如 10 分钟）
  - 空跑检测阈值（连续 N 轮 CHANGES 为空且无进展则自动 Pause）
- 日志：
  - 是否落盘 runs/ 目录
  - 单轮最大保存文本（防 DB 爆炸）
- Provider 配置透传：
  - Codex：sandbox（read-only/workspace-write）、是否 full-auto
  - Claude：max-turns、output-format（json/stream-json）

---

## 6. 后端 API 设计（REST + SSE）

### 6.1 REST
- POST `/api/workspaces`
  - { name, rootPath, planPath? }
- GET `/api/workspaces`
- POST `/api/sessions`
  - { workspaceId, role: "manager"|"executor", provider: "codex"|"claude", config }
- GET `/api/sessions?workspaceId=...`
- POST `/api/runs`
  - { workspaceId, managerSessionId, executorSessionId, options }
- GET `/api/runs?workspaceId=...`
- GET `/api/runs/:runId`
- POST `/api/runs/:runId/start`
- POST `/api/runs/:runId/pause`
- POST `/api/runs/:runId/step`（可选：stepMode=manager|executor|full）
- POST `/api/runs/:runId/stop`
- POST `/api/runs/:runId/inject`
  - { target: "manager"|"executor", text }
- GET `/api/runs/:runId/export?format=md|json|jsonl`

### 6.2 SSE（推荐）
- GET `/api/events?runId=...`
  - 事件格式：
    - `{ ts, runId, role, kind, payload }`
    - kind: `status` | `prompt` | `partial` | `final` | `tool` | `error` | `meta`
  - 前端断线自动重连：带 `lastEventId` 继续拉取

> Codex：`--json` 输出 JSONL 事件；Claude：`--output-format stream-json` 可产生流式事件（可转成 SSE）。

---

## 7. 数据库（SQLite）Schema（建议）

### 7.1 表
- workspaces(id, name, rootPath, planPath, createdAt, updatedAt)
- sessions(id, workspaceId, role, provider, providerSessionId, configJson, createdAt, lastActiveAt)
- runs(id, workspaceId, managerSessionId, executorSessionId, status, turnIndex, createdAt, endedAt, optionsJson)
- turns(id, runId, index, startedAt, endedAt, managerPrompt, managerOutput, executorPrompt, executorOutput, outcomeJson)
- events(id, runId, turnId?, seq, ts, role, kind, payloadJson)   # 用于完整回放/调试
- artifacts(id, runId, type, path, metaJson, createdAt)          # 导出文件索引

### 7.2 关键设计点
- `providerSessionId`：
  - Codex：保存 exec session id（resume 用）
  - Claude：保存 `--session-id` 或 `--resume` 的 id/name（按你的策略）
- turns 的 prompt/output 可能很大：需要"截断策略"（例如保留最近 N KB + 全量落盘 runs/）

---

## 8. Orchestrator 状态机与保护措施（防止空跑/卡死）

### 8.1 状态机
- IDLE -> RUNNING -> (PAUSED) -> RUNNING -> DONE/STOPPED/ERROR

### 8.2 保护措施（建议 MVP 就有）
- MAX_TURNS：默认 50（可配置）
- per-turn 超时：默认 10 分钟（可配置）
- 空跑检测：
  - 若连续 N 轮 executor CHANGES 为空且 manager 没改变策略 => 自动 PAUSE，并提示"需要人工介入"
- 失败重试（轻量）：
  - provider 调用失败：指数退避重试 2 次
  - CLI 不存在/未登录：立即报错并给出诊断提示

---

## 9. Prompt 资产（工程化：可版本控制）

目录：`/prompts`
- `manager_system.md`
- `executor_system.md`
- `manager_prefix.md`（可选：每轮自动附加的 rubric）
- `executor_prefix.md`

### 9.1 manager_system.md（核心要求）
- 明确身份：总控/诊断/拆解 plan.md
- 明确输出约束：完成时只能输出 Done
- 明确节奏：一次只下发一个"最小可交付步骤"
- 明确边界：不要让 executor 发散做未要求内容

### 9.2 executor_system.md（核心要求）
- 明确身份：只执行，不做全局规划（规划归总管）
- 明确日志格式：必须输出 EXEC_LOG
- 明确安全：先跑轻量验证（lint/test），再做更大改动

---

## 10. repoDigest（给总管"根据当前文件夹深度思考"的材料）

### 10.1 生成策略（可配置开关）
- 文件树摘要（深度 3、总行数上限 300）
- `git status --porcelain`
- `git diff --stat`
- （可选）最近一次失败测试输出（缓存）

> 注意：repoDigest 不要每轮塞太大，否则上下文爆掉；建议"变化时更新 + 关键轮次追加"。

---

## 11. 安全与远程访问（手机出差场景必须考虑）

### 11.1 必须做（MVP）
- 访问控制：`ADMIN_TOKEN`（header 或 query），否则拒绝所有写操作（start/stop/inject/export）
- UI 只读访问可选开关（便于你分享给同事看进度）
- 禁止把服务直接裸露在公网（除非你真的懂怎么做 HTTPS/反向代理/ACL）

### 11.2 推荐做（后续增强）
- HTTPS：本地自签 + 手机信任，或用 Tailscale/ZeroTier 形成内网访问
- 审计日志：记录所有 Start/Stop/Inject 操作（落库 + 落盘）

---

## 12. 工程实现里程碑（按可交付拆）

### M0：脚本原型（1 天内）
- CLI 手工跑通：
  - Codex：manager/executor 两个角色的 `codex exec --json` 能跑通并落盘；不强依赖 resume（MVP 先显式上下文）
  - Claude：`-p --output-format stream-json --include-partial-messages` 能流式输出
- Orchestrator 最小循环（无 Web）

DoD：
- 终端中能跑至少 2 轮交替；manager 输出 Done 能结束。

### M1：Web MVP（可用）（~4 天）
- Express + SSE
- Run Dashboard：能 start/stop，能看流式输出
- SQLite 持久化：runs/turns/events
- Session 管理：新建 manager/executor session，并绑定到 run

DoD：
- 手机浏览器可访问，能顺畅观察与控制一个 run。

### M2：体验增强（3~7 天）
- Pause/Step
- History：回放/搜索/导出
- Inject：手动插话纠偏
- repoDigest 展示与开关
- 空跑检测与超时

DoD：
- 出差手机上可以"看进度 + 暂停 + 插话 + 导出对话"。

### M3：严格模式与多 Provider 更稳（可选）
- Manager 指令包 JSON 化 + schema 校验：
  - Codex：`--output-schema`
  - Claude：`--json-schema`
- Provider 配置页面更细（sandbox/max-turns 等）

DoD：
- 自动化解析更稳，减少"总管输出不合规"导致的跑偏。

---

## 13. 测试计划（别省，不然后面很痛）
- 单元测试
  - ProviderAdapter：解析 JSONL / stream-json 的边界
  - Orchestrator：Done 检测、暂停/停止、超时、空跑
- 集成测试（需要本机安装 CLI）
  - 用一个 demo repo + demo plan.md 跑 3 轮，验证落库与回放
- E2E（可选）
  - Playwright：手机 viewport 下 Start/Stop/History/Export 基本流程

---

## 14. Demo plan.md（用于自测的最小任务）
在一个 demo repo 放一个 plan.md，例如：
- 任务1：添加一个 hello endpoint + 单测
- 任务2：修一个 lint 规则
- 任务3：README 更新
验证 manager 最终能输出 Done 并结束。

---

## 15. 风险清单（提前规避）
- 远程访问安全风险：这是"远程执行本机代码"的控制台，必须加 token、别裸奔公网。
- 上下文膨胀：长 run 必须截断/摘要，否则 manager 诊断会越来越不准。
- Provider 输出格式变化：尽量依赖官方支持的 json/stream-json/schema 特性，而不是脆弱的字符串匹配。

---

## 16. 最终验收（你拿手机就能用）
- 打开网页 -> 选 workspace -> 新建 manager/executor（可选 codex/claude）-> 创建 run -> Start
- 看到 manager 下发指令、executor 执行回传、往返多轮
- 任何时刻可以 Pause/Stop/Inject
- Run 结束时 manager 输出 Done，系统自动停止
- 在 History 里能回看全部轮次并导出 Markdown
